MongoDB Scheme Design
=====================

数据库设计是应用开发的基础，以前开发不规范，没有意识到这些东西，其实不仅仅要设计好，
还好弄出来一些UML图来表示逻辑实体间的关系，方便理解清楚脉络。

基于相册的主要关系实体
-------------------

要捋清楚，后面才好开发，整个应用架构才会清晰。  

- 用户，云相册的使用对象，可以注册、登陆，新建相册、上传图片、发布Post，留言评论，收藏相册，关注用户，加入分馆  
- 分馆，微澜云相册的很重要的实体，在社区中绝对重要。在这里也很重要，但是不能超越用户。
  - 用户从属分馆的权限问题，馆长、管理员、馆员、临时馆员、游客  
  - 馆长、管理员可以管理分馆信息、分馆相册、图片，可以设置人员权限
  - 馆员可以上传图片、删除自己的图片、发布Post
  - 临时馆员，拥有临时的馆员权限，有时限会过期，三天、一周或一个月。
  - 游客，访客访问权限，不可浏览、可浏览、可上传图片、可创建相册
  - 权限表，相册CURD、图片CD、Post CURD
  - 角色表如上，角色关联相应的权限，所有分馆统一使用这些角色，馆长可以分配角色。
  - 以上是分馆数据的默认设置，相册可以单独设置权限，限制访问角色，仅馆员可以访问、开放访问。
- 评论存储问题，分馆、用户、相册、图片全部都允许评论。
  - 图片的评论数量顶多在几百以内，embeded存储即可。
  - 相册因为图片众多，所以需要独立存储在相册评论表，然后加reference。
  - 相册评论表中，分馆相册类型为 group_album, 用户相册类型为 user_album
  - 分馆和用户评论也可以存储在相册评论表，类型为 group, user
  - 额外的relative_id字段，关联相册ID或者分馆ID或者用户ID 
- 图片单独一张表，存储图片链接、大小、上传用户、点赞用户、评论、置顶评论、收藏（embeded）
  - 收藏图片的同时，用户表里也添加收藏数据图片的ID  
  - 图片表  图片ID，用户ID，图片地址，缩略图地址，创建时间，权限设置，状态，创建时间   
  - 添加用户ID为索引，查看用户的图片直接根据用户ID就可以 
  - 添加分馆ID为索引，查看分馆的图片直接根据分馆ID就可以 
- 分馆相册、用户相册，存储相册基本信息，评论ID数组，Posts ID数组，相册置顶评论
  - 分馆ID，相册名称，创建时间，权限设置
  - 相册和图片的关联问题，相册的图片直接内嵌相册，因为相册是要单独创建的，数量不会很大。
  - 个人相册的权限，开放访问、登陆用户访问、指定用户访问、指定分馆访问、私人访问。
- Post问题，Post是一次用户上传图片的行为，包含评论、地址、Tag
  - Google Photos 是没有这个的，因为Google Photos 的重点是私有或家庭云相册，不在于社交
  - Instagram 是有的，因为社交是其中重中之重，所以有Posts单独查看。
  - 云相册的定位是有社交的，在微澜的运作过程中，分享各个瞬间，给志愿者和分馆更好的展示。
  - 而且Instagram的评论都是针对Posts的。
- 用户关注表，双向绑定。
- 信息通知表，留言回复、系统通知、点赞收藏关注。

这样社交性会大大下降，而且各种审核和权限，减少了社区的扁平化和开放性，所以不采用这种形式。

基于Posts的主要实体关系
--------------------

- 用户，可以注册、登陆，发布Post，留言评论收藏，关注用户
- 分馆，弱隶属关系，类似博客分类的感觉，用户发布Posts时，可以设置分馆或者不设置。 
- Posts，动态，包含一张或多张图片，评论、收藏、点赞的客体，属于用户，可以关联分馆。
  - 其中包含的图片数据进行denormalize，不仅包含图片ObjectID，还包含预览图以及大小。 
  - 甚至直接存完整的图片数据也可以。  
- 用户关注表，关注用户ID，被关注用户ID follower, following
- 图片，属于Posts的一部分，包含原图、缩略图、预览图、时间戳、大小、主要颜色、用户ID。
- feed信息，从关注的用户的posts数据查询，提供日期作为查询条件   
- 信息通知表，留言回复、系统通知、点赞收藏关注。
  - 这个好重要，需要考虑性能以及消息的多样性
  - 用户评论、点赞、收藏、关注，都会产生消息，能够及时通知，会大大提高社交体验
  - 还有系统通知，让系统的变更、回复，及时地触达用户

这样其实简单清晰多了，OK，开始编码吧！    


创建数据库及用户
--------------


添加数据库 wavelib_photo，创建角色如下：

```js
use wavelib_photo;
db.createUser(
  {
    user: "wavelib_photo",
    pwd: "wavelib_photo",
    roles: [
      { role: "readWrite", db: "wavelib_photo" }
    ]
  }
);
```

使用 Mongo 进行连接：
```sh
$ mongo --port 27017 -u wavelib_photo --authenticationDatabase 'wavelib_photo'
```
